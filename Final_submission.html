<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Habitat Layout Studio — Auto + Materials/Cost</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { user-select: none; }
    .draggable { cursor: move; }
    .badge { font-size: 10px; padding: 2px 6px; border-radius: 9999px; }
    @keyframes pulse { 0% { stroke-width: 0.6; opacity: 0.9; } 100% { stroke-width: 2.0; opacity: 0; } }
    .spawn-pulse { animation: pulse 600ms ease-out 1; }
    .num { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-[1400px] mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold">Habitat Layout Studio</h1>
        <p class="text-slate-300 text-sm">Auto-design + custom editor + materials, shielding, ISRU & costs.</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnDownloadJSON" class="bg-emerald-600 hover:bg-emerald-500 rounded-xl px-3 py-2">Download JSON</button>
        <button id="btnDownloadPNG"  class="bg-emerald-800 hover:bg-emerald-700 rounded-xl px-3 py-2">Download PNG</button>
      </div>
    </header>

    <section class="grid xl:grid-cols-[390px,1fr] gap-4">
      <aside class="space-y-4">
        <!-- Mission profile -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
          <h2 class="font-semibold">Mission Profile</h2>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label>Crew Size</label><input id="crewSize" type="number" class="bg-slate-800 rounded-xl p-2" value="4" />
            <label>Mission Days</label><input id="missionDays" type="number" class="bg-slate-800 rounded-xl p-2" value="30" />
            <label>Deck Height (m)</label><input id="deckHeight" type="number" step="0.1" class="bg-slate-800 rounded-xl p-2" value="2.7" />
            <label>Corridor Factor</label><input id="corridorFactor" type="number" step="0.05" class="bg-slate-800 rounded-xl p-2" value="0.25" />
          </div>
        </div>

        <!-- Hull shape -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
          <h2 class="font-semibold">Hull Shape</h2>
          <select id="shapeType" class="w-full bg-slate-800 rounded-xl p-2">
            <option value="cylinder">Cylinder</option>
            <option value="sphere">Sphere</option>
            <option value="toroid">Toroid</option>
          </select>
          <div id="shapeInputs" class="grid grid-cols-2 gap-2 mt-2"></div>
          <div class="grid grid-cols-2 gap-2 text-sm mt-1">
            <div>Volume:</div><div><span id="volM3" class="font-semibold num">0</span> m³</div>
            <div>Est. Crew Cap (25 m³/crew):</div><div><span id="crewCap" class="font-semibold num">0</span></div>
          </div>
        </div>

        <!-- Budgets -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
          <h2 class="font-semibold">Budgets</h2>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label>Power Supply (kW)</label><input id="powerSupply" type="number" class="bg-slate-800 rounded-xl p-2" value="60" />
            <label>Mass Budget (t)</label><input id="massBudget" type="number" class="bg-slate-800 rounded-xl p-2" value="25" />
          </div>
          <div class="text-sm mt-1">
            Power Used: <span id="powerUsed" class="font-semibold num">0</span> kW ·
            Mass: <span id="massUsed" class="font-semibold num">0</span> t
          </div>
        </div>

        <!-- Auto Designer -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Auto Designer</h2>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label>Preset</label>
            <select id="presetSelect" class="bg-slate-800 rounded-xl p-2">
              <option value="crew">Crew-Comfort</option>
              <option value="science">Science-Focused</option>
              <option value="logistics">Logistics-Focused</option>
            </select>
            <label>Variations</label>
            <input id="variationCount" type="number" min="1" max="6" value="3" class="bg-slate-800 rounded-xl p-2" />
          </div>
          <div class="flex gap-2">
            <button id="btnGenerateAuto" class="bg-indigo-600 hover:bg-indigo-500 rounded-xl px-3 py-2 text-sm">Generate Options</button>
            <button id="btnClearOptions" class="bg-slate-800 hover:bg-slate-700 rounded-xl px-3 py-2 text-sm">Clear</button>
          </div>
          <div id="autoOptionsList" class="space-y-2"></div>
          <div class="text-xs text-slate-400">Apply an option to load it into the active deck—then tweak.</div>
        </div>

        <!-- Module Library -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Module Library</h2>
            <button id="btnAutoPlace" class="text-xs bg-slate-800 hover:bg-slate-700 rounded-lg px-2 py-1">Auto-Layout (current)</button>
          </div>
          <div id="moduleList" class="grid gap-2 text-sm"></div>
          <div class="text-xs text-slate-400">Drag into the canvas, or click “Place”.</div>
        </div>

        <!-- Rule Checks -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
          <h2 class="font-semibold">Rule Checks</h2>
          <ul id="ruleList" class="text-sm list-disc pl-5 space-y-1"></ul>
        </div>
      </aside>

      <!-- Right column: Canvas + engineering panels -->
      <main class="space-y-4">
        <!-- Canvas & Decks -->
        <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm text-slate-300">Top-down deck view • Grid=1m • Drag modules inside hull</div>
            <div class="flex items-center gap-2">
              <span class="text-sm">Decks:</span>
              <div id="deckTabs" class="flex flex-wrap gap-2"></div>
              <button id="btnAddDeck" class="text-xs bg-slate-800 hover:bg-slate-700 rounded-lg px-2 py-1">+ Deck</button>
              <button id="btnDelDeck" class="text-xs bg-slate-800 hover:bg-slate-700 rounded-lg px-2 py-1">− Deck</button>
            </div>
          </div>

          <svg id="canvas" viewBox="0 0 120 80" class="w-full aspect-[120/80] bg-slate-950 rounded-2xl border border-slate-800">
            <defs><pattern id="grid" width="1" height="1" patternUnits="userSpaceOnUse"><path d="M1 0 V1 H0" stroke="#243142" stroke-width="0.05"/></pattern></defs>
            <rect x="0" y="0" width="120" height="80" fill="url(#grid)" />
            <g id="hull"></g>
            <g id="spawnFX"></g>
            <g id="modules"></g>
          </svg>

          <div class="mt-3 grid md:grid-cols-3 gap-2 text-sm">
            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3">
              <div class="font-semibold mb-1">Deck Metrics</div>
              <div>Deck Area: <span id="deckArea" class="num">0</span> m²</div>
              <div>Used Area: <span id="usedArea" class="num">0</span> m²</div>
              <div>Utilization: <span id="utilPct" class="num">0%</span></div>
            </div>
            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3">
              <div class="font-semibold mb-1">Habitat Totals</div>
              <div>Decks: <span id="deckCount" class="num">1</span></div>
              <div>Total Area: <span id="totalArea" class="num">0</span> m²</div>
              <div>Total Volume: <span id="totalVol" class="num">0</span> m³</div>
            </div>
            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3">
              <div class="font-semibold mb-1">Tips</div>
              <div class="text-slate-300">Use Auto Designer for fast options; keep utilization ≤ ~75% to maintain egress.</div>
            </div>
          </div>
        </div>

        <!-- Materials & Shielding -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Materials & Shielding</h2>
            <div class="text-xs text-slate-400">Shielding mass can be added directly or made via ISRU.</div>
          </div>
          <div class="grid lg:grid-cols-3 gap-3 text-sm mt-2">
            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="font-semibold">Material Library (key entries)</div>
              <div id="matList" class="space-y-2"></div>
            </div>

            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="font-semibold">Shielding Calculator</div>
              <label>Shield Material</label>
              <select id="shieldMaterial" class="bg-slate-800 rounded-xl p-2 w-full"></select>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <label>Target Areal Density (g/cm²)</label>
                <input id="shieldAreal" type="number" step="0.5" value="20" class="bg-slate-800 rounded-xl p-2" />
                <label>Apply to Walls?</label>
                <select id="shieldWhere" class="bg-slate-800 rounded-xl p-2">
                  <option value="walls">Walls (perimeter × deckHeight × decks)</option>
                  <option value="custom">Custom Area (m²)</option>
                </select>
                <label id="customAreaLbl" class="hidden">Custom Area (m²)</label>
                <input id="customArea" type="number" step="1" value="50" class="bg-slate-800 rounded-xl p-2 hidden" />
              </div>
              <div class="text-xs text-slate-300 mt-1">1 g/cm² = 10 kg/m².</div>
              <div class="mt-2 text-sm">
                <div>Shield Area: <span id="shieldArea" class="num font-semibold">0</span> m²</div>
                <div>Shield Mass: <span id="shieldMass" class="num font-semibold">0</span> t</div>
                <div>Approx. Thickness: <span id="shieldThick" class="num font-semibold">0</span> cm</div>
              </div>
              <div class="flex gap-2 mt-2">
                <button id="btnApplyShield" class="bg-indigo-600 hover:bg-indigo-500 rounded-lg px-3 py-2 text-xs">Apply Shielding Mass</button>
                <button id="btnClearShield" class="bg-slate-800 hover:bg-slate-700 rounded-lg px-3 py-2 text-xs">Clear Shielding Mass</button>
              </div>
            </div>

            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="font-semibold">ISRU (Make Shielding On-Site)</div>
              <div class="grid grid-cols-2 gap-2">
                <label>Use ISRU for Shielding?</label>
                <select id="isruUse" class="bg-slate-800 rounded-xl p-2">
                  <option value="no">No (import shielding mass)</option>
                  <option value="yes">Yes (import plant, not shielding)</option>
                </select>
                <label>ISRU Plant Mass (t)</label>
                <input id="isruMass" type="number" step="0.1" value="2.5" class="bg-slate-800 rounded-xl p-2" />
                <label>ISRU Power (kW)</label>
                <input id="isruPower" type="number" step="0.1" value="8" class="bg-slate-800 rounded-xl p-2" />
              </div>
              <div class="text-xs text-slate-400">When ISRU = Yes, shielding mass is not imported; plant mass and power are added to totals.</div>
            </div>
          </div>
        </div>

        <!-- Logistics & Cost -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <h2 class="font-semibold">Logistics & Cost</h2>
          <div class="grid lg:grid-cols-3 gap-3 text-sm mt-2">
            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="font-semibold">Launch Pricing (editable)</div>
              <div class="grid grid-cols-2 gap-2">
                <label>First 50 kg (USD)</label>
                <input id="cFirstBlock" type="number" value="300000" class="bg-slate-800 rounded-xl p-2" />
                <label>Per kg after (USD/kg)</label>
                <input id="cPerKg" type="number" value="6500" class="bg-slate-800 rounded-xl p-2" />
                <label>LEO → Destination Multiplier</label>
                <input id="cBeyondLEO" type="number" step="0.1" value="4" class="bg-slate-800 rounded-xl p-2" />
              </div>
              <div class="text-xs text-slate-400">Use the multiplier to approximate lunar/Martian delivery factors.</div>
            </div>

            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="font-semibold">Mass Breakdown</div>
              <div>Modules Mass: <span id="massModules" class="num font-semibold">0</span> t</div>
              <div>Shielding Mass (imported): <span id="massShieldingImported" class="num font-semibold">0</span> t</div>
              <div>ISRU Plant Mass: <span id="massISRU" class="num font-semibold">0</span> t</div>
              <div>Total Imported Mass: <span id="massImported" class="num font-semibold">0</span> t</div>
            </div>

            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="font-semibold">Cost Estimates</div>
              <div>To LEO: <span id="costLEO" class="num font-semibold">$0</span></div>
              <div>To Destination: <span id="costDest" class="num font-semibold">$0</span></div>
              <div class="text-xs text-slate-400">Educational estimates only—edit values to run what-ifs.</div>
            </div>
          </div>
        </div>
      </main>
    </section>
  </div>

  <script>
    // -------------- Library --------------
    const DEFAULT_LIBRARY = [
      { id:'airlock',  name:'Airlock',        w:6, h:4, power:2,  mass:0.8,  tags:['access'],    required:true,  color:'#60a5fa' },
      { id:'life',     name:'Life Support',   w:6, h:4, power:8,  mass:2.0,  tags:['critical'],  required:true,  color:'#fbbf24' },
      { id:'life2',    name:'Life Support B', w:4, h:3, power:5,  mass:1.2,  tags:['redundant'], required:false, color:'#fde047' },
      { id:'med',      name:'Med Bay',        w:5, h:4, power:5,  mass:1.0,  tags:['care'],      required:false, color:'#f472b6' },
      { id:'sleep',    name:'Sleep Pod',      w:4, h:3, power:1,  mass:0.4,  tags:['crew'],      required:false, color:'#22d3ee' },
      { id:'galley',   name:'Galley',         w:5, h:3, power:4,  mass:0.7,  tags:['ops'],       required:false, color:'#34d399' },
      { id:'waste',    name:'Waste Mgmt',     w:4, h:3, power:2,  mass:0.6,  tags:['ops'],       required:false, color:'#c084fc' },
      { id:'exercise', name:'Exercise',       w:6, h:4, power:3,  mass:0.9,  tags:['health'],    required:false, color:'#f87171' },
      { id:'lab',      name:'Science Lab',    w:6, h:4, power:6,  mass:1.8,  tags:['science'],   required:false, color:'#93c5fd' },
      { id:'comms',    name:'Comms/Bridge',   w:3, h:3, power:3,  mass:0.5,  tags:['systems'],   required:false, color:'#67e8f9' },
      { id:'storage',  name:'Stowage',        w:5, h:3, power:0.5,mass:1.1,  tags:['logistics'], required:false, color:'#a3e635' }
    ];

    // -------------- Materials (for display + shielding calc) --------------
    const MATERIALS = [
      { id:'al-li', name:'Al-Li Alloy (structure)', density:2700, usd_per_kg:15, note:'Primary shell/frames' },
      { id:'ti64',  name:'Ti-6Al-4V (frames)',      density:4430, usd_per_kg:35, note:'High strength, expensive' },
      { id:'cfrp',  name:'CFRP Panel',              density:1600, usd_per_kg:60, note:'Stiff, low-mass' },
      { id:'pe',    name:'Polyethylene (shield)',   density:950,  usd_per_kg:4,  note:'Good H-rich shielding' },
      { id:'water', name:'Water Wall (shield)',     density:1000, usd_per_kg:1,  note:'Also life support store' },
      { id:'mlI',   name:'MLI Blanket',             density:100,  usd_per_kg:30, note:'Thermal control' },
      { id:'reg',   name:'Regolith (ISRU shield)',  density:1700, usd_per_kg:0.2, note:'Local, thick needed' }
    ];
    // Shielding menu subset
    const SHIELD_CHOICES = ['pe','water','reg'];

    // -------------- State --------------
    const state = {
      grid: 1,
      hullBounds: { x: 10, y: 5, w: 100, h: 70 }, // SVG units ~ meters
      shape: { type:'cylinder', dims:{ radius:6, height:8 } },
      deckHeight: 2.7,
      decks: [{ id:'D1', name:'Deck 1', modules:[] }],
      activeDeck: 0,
      corridorFactor: 0.25,
      crewSize: 4,
      missionDays: 30,
      powerSupply: 60,
      massBudget: 25,
      library: structuredClone(DEFAULT_LIBRARY),
      autoOptions: [],
      // Shielding/ISRU/Cost
      shielding: { material:'pe', areal_gcm2:20, where:'walls', area_m2:0, mass_t:0, applied:false },
      isru: { use:false, mass_t:2.5, power_kW:8 },
      costs: { first50_usd:300000, perkg_usd:6500, beyondLEO:4 }
    };

    // -------------- DOM refs --------------
    const el = id => document.getElementById(id);
    const canvas = el('canvas'), hullG = el('hull'), modulesG = el('modules'), spawnFX = el('spawnFX');
    const moduleList = el('moduleList'), ruleList = el('ruleList'), deckTabs = el('deckTabs');

    const volM3 = el('volM3'), crewCap = el('crewCap'), deckAreaEl = el('deckArea'),
          usedAreaEl = el('usedArea'), utilPctEl = el('utilPct'), deckCountEl = el('deckCount'),
          totalAreaEl = el('totalArea'), totalVolEl = el('totalVol');

    const shapeType = el('shapeType'), shapeInputs = el('shapeInputs');
    const crewSizeEl = el('crewSize'), missionDaysEl = el('missionDays'),
          deckHeightEl = el('deckHeight'), corridorFactorEl = el('corridorFactor');
    const powerSupplyEl = el('powerSupply'), massBudgetEl = el('massBudget'),
          powerUsedEl = el('powerUsed'), massUsedEl = el('massUsed');

    const btnAddDeck = el('btnAddDeck'), btnDelDeck = el('btnDelDeck'), btnAutoPlace = el('btnAutoPlace');
    const btnDownloadJSON = el('btnDownloadJSON'), btnDownloadPNG = el('btnDownloadPNG');

    const presetSelect = el('presetSelect'), variationCount = el('variationCount'),
          btnGenerateAuto = el('btnGenerateAuto'), btnClearOptions = el('btnClearOptions'),
          autoOptionsList = el('autoOptionsList');

    // Materials/Shielding UI
    const matList = el('matList');
    const shieldMaterial = el('shieldMaterial'), shieldAreal = el('shieldAreal'),
          shieldWhere = el('shieldWhere'), customAreaLbl = el('customAreaLbl'), customArea = el('customArea');
    const shieldArea = el('shieldArea'), shieldMass = el('shieldMass'), shieldThick = el('shieldThick');
    const btnApplyShield = el('btnApplyShield'), btnClearShield = el('btnClearShield');

    const isruUse = el('isruUse'), isruMass = el('isruMass'), isruPower = el('isruPower');

    // Cost UI
    const cFirstBlock = el('cFirstBlock'), cPerKg = el('cPerKg'), cBeyondLEO = el('cBeyondLEO');
    const massModules = el('massModules'), massShieldingImported = el('massShieldingImported'),
          massISRU = el('massISRU'), massImported = el('massImported');
    const costLEO = el('costLEO'), costDest = el('costDest');

    // -------------- Geometry / helpers --------------
    function volumeM3(shape) {
      const { type, dims } = shape;
      if (type==='cylinder') return Math.PI * dims.radius * dims.radius * dims.height;
      if (type==='sphere')   return (4/3)*Math.PI*Math.pow(dims.radius,3);
      const {R=10,r=3} = dims; return 2*Math.PI*Math.PI*R*r*r; // toroid
    }
    function deckArea() { const { w, h } = state.hullBounds; return w*h; }
    function totalArea() { return deckArea() * state.decks.length; }
    function currentDeck(){ return state.decks[state.activeDeck]; }
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function fmtUSD(n){ return '$' + Math.round(n).toLocaleString(); }

    // -------------- Drawing --------------
    function drawHull() {
      hullG.innerHTML='';
      const {x,y,w,h} = state.hullBounds;
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',x); rect.setAttribute('y',y);
      rect.setAttribute('width',w); rect.setAttribute('height',h);
      rect.setAttribute('rx',7); rect.setAttribute('ry',7);
      rect.setAttribute('fill','none'); rect.setAttribute('stroke','#334155'); rect.setAttribute('stroke-width','0.6');
      hullG.appendChild(rect);
    }
    function renderDeckTabs() {
      deckTabs.innerHTML='';
      state.decks.forEach((d,i)=>{
        const b=document.createElement('button');
        b.className='px-3 py-1 rounded-lg border '+(i===state.activeDeck?'bg-slate-700 border-slate-600':'bg-slate-800 border-slate-700 hover:bg-slate-700');
        b.textContent=d.name; b.onclick=()=>{state.activeDeck=i; updateAll();};
        deckTabs.appendChild(b);
      });
      deckCountEl.textContent=state.decks.length;
    }

    // -------------- Library UI --------------
    function renderModuleLibrary() {
      moduleList.innerHTML='';
      state.library.forEach(m=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between bg-slate-800/60 rounded-xl px-3 py-2';
        row.setAttribute('draggable','true'); row.dataset.libid=m.id;

        const placedCount = state.decks.reduce((s,d)=>s+d.modules.filter(x=>x.libId===m.id).length,0);
        row.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="inline-block w-3 h-3 rounded" style="background:${m.color}"></span>
            <span>${m.name}</span>
            ${m.required ? `<span class="badge bg-amber-500/20 text-amber-300 border border-amber-500/30">required</span>`:''}
          </div>
          <div class="text-xs text-right">${m.w}×${m.h} m • ${m.power} kW • ${m.mass} t
            <div class="text-slate-400">Placed: ${placedCount}</div>
          </div>
          <button class="text-xs bg-slate-700 hover:bg-slate-600 rounded-lg px-2 py-1">Place</button>
        `;
        row.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', m.id); });
        row.querySelector('button').onclick = ()=>{
          const p = lastMouseSvg ?? { x: state.hullBounds.x + state.hullBounds.w/2, y: state.hullBounds.y + state.hullBounds.h/2 };
          spawnModule(m.id, p.x, p.y, true);
        };
        moduleList.appendChild(row);
      });
    }

    // -------------- Modules render + drag --------------
    let drag=null, lastMouseSvg=null;
    function svgPointFromClient(evt){ const pt=canvas.createSVGPoint(); pt.x=evt.clientX; pt.y=evt.clientY; return pt.matrixTransform(canvas.getScreenCTM().inverse()); }

    function renderModules(){
      modulesG.innerHTML='';
      const d=currentDeck();
      d.modules.forEach(m=>{
        const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.classList.add('draggable'); g.dataset.id=m.id;

        const r=document.createElementNS('http://www.w3.org/2000/svg','rect');
        r.setAttribute('x',m.x); r.setAttribute('y',m.y);
        r.setAttribute('width',m.w); r.setAttribute('height',m.h);
        r.setAttribute('fill',m.color); r.setAttribute('fill-opacity','0.8');
        r.setAttribute('stroke','#0f172a'); r.setAttribute('stroke-width','0.3');
        g.appendChild(r);

        const label=document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x',m.x+0.3); label.setAttribute('y',m.y+1.2);
        label.setAttribute('font-size','1.2'); label.setAttribute('fill','#0b1220'); label.textContent=m.name; g.appendChild(label);

        const del=document.createElementNS('http://www.w3.org/2000/svg','text');
        del.textContent='✕'; del.setAttribute('x',m.x+m.w-1); del.setAttribute('y',m.y+1.1);
        del.setAttribute('font-size','1.2'); del.setAttribute('fill','#111827'); del.style.cursor='pointer';
        del.addEventListener('click',()=>{ d.modules=d.modules.filter(mm=>mm.id!==m.id); updateAll(); }); g.appendChild(del);

        const rot=document.createElementNS('http://www.w3.org/2000/svg','text');
        rot.textContent='⟳'; rot.setAttribute('x',m.x+m.w-2.2); rot.setAttribute('y',m.y+1.1);
        rot.setAttribute('font-size','1.2'); rot.setAttribute('fill','#111827'); rot.style.cursor='pointer';
        rot.addEventListener('click',()=>{ const nw=m.h, nh=m.w; m.w=nw; m.h=nh; clampInHull(m); updateAll(); }); g.appendChild(rot);

        g.addEventListener('mousedown', e=>startDrag(e,m));
        modulesG.appendChild(g);
      });
    }

    canvas.addEventListener('mousemove', e=>{
      lastMouseSvg=svgPointFromClient(e);
      if(!drag) return;
      const d=currentDeck();
      const m = d.modules.find(mm=>mm.id===drag.id); if(!m) return;
      let nx=Math.round((lastMouseSvg.x-drag.offX)/state.grid)*state.grid;
      let ny=Math.round((lastMouseSvg.y-drag.offY)/state.grid)*state.grid;
      m.x=nx; m.y=ny; clampInHull(m); updateAll();
    });
    window.addEventListener('mouseup', ()=>{ drag=null; });
    canvas.addEventListener('dragover', e=>e.preventDefault());
    canvas.addEventListener('drop', e=>{
      e.preventDefault();
      const libId=e.dataTransfer.getData('text/plain'); if(!libId) return;
      const p=svgPointFromClient(e); spawnModule(libId, p.x, p.y, true);
    });

    function startDrag(evt,m){ const p=svgPointFromClient(evt); drag={id:m.id, offX:p.x-m.x, offY:p.y-m.y}; }
    function clampInHull(m){ const {x,y,w,h}=state.hullBounds; m.x=Math.max(x,Math.min(m.x, x+w-m.w)); m.y=Math.max(y,Math.min(m.y, y+h-m.h)); }
    function spawnPulse(x,y,w,h){ spawnFX.innerHTML=''; const a=document.createElementNS('http://www.w3.org/2000/svg','rect'); a.setAttribute('x',x); a.setAttribute('y',y); a.setAttribute('width',w); a.setAttribute('height',h); a.setAttribute('fill','none'); a.setAttribute('stroke','#93c5fd'); a.setAttribute('class','spawn-pulse'); spawnFX.appendChild(a); setTimeout(()=>spawnFX.innerHTML='',600); }
    function spawnModule(libId, x, y, centered=false){
      const def=state.library.find(m=>m.id===libId); if(!def) return;
      const d=currentDeck(); const inst={ id:uid(), libId:def.id, name:def.name, w:def.w, h:def.h, power:def.power, mass:def.mass, color:def.color, x, y };
      if(centered){ inst.x=x-inst.w/2; inst.y=y-inst.h/2; }
      clampInHull(inst); d.modules.push(inst); spawnPulse(inst.x, inst.y, inst.w, inst.h); updateAll();
    }

    // -------------- Auto layout (for already-placed modules) --------------
    function autoLayoutActiveDeck(){
      const d=currentDeck(); const {x,y,w,h}=state.hullBounds;
      const pad=1; let cx=x+pad, cy=y+pad, rowH=0;
      const sorted=[...d.modules].sort((a,b)=>(b.h*b.w)-(a.h*a.w));
      sorted.forEach(m=>{
        if(cx+m.w+pad>x+w){ cx=x+pad; cy+=rowH+pad; rowH=0; }
        if(cy+m.h+pad>y+h){ m.x=x+w-m.w-pad; m.y=y+h-m.h-pad; }
        else { m.x=cx; m.y=cy; cx+=m.w+pad; rowH=Math.max(rowH,m.h); }
      });
    }

    // -------------- Rules & metrics --------------
    function sumAcrossHab(field){ return state.decks.reduce((s,d)=> s + d.modules.reduce((t,m)=> t + (m[field]||0),0), 0); }
    function centerDist(a,b){ const ax=a.x+a.w/2, ay=a.y+a.h/2, bx=b.x+b.w/2, by=b.y+b.h/2; return Math.hypot(ax-bx,ay-by); }

    function checkRules(){
      ruleList.innerHTML='';
      const add=(ok,msg)=>{ const li=document.createElement('li'); li.textContent=(ok?'✅ ':'⚠️ ')+msg; li.className=ok?'text-emerald-400':'text-amber-300'; ruleList.appendChild(li); };

      const placedIds = new Set(state.decks.flatMap(d=>d.modules.map(m=>m.libId)));
      const requiredOk = state.library.filter(m=>m.required).every(m=>placedIds.has(m.id));
      add(requiredOk,'Required modules placed (Airlock + Life Support).');

      const redundancyOk = placedIds.has('life') && (placedIds.has('life2') || [...placedIds].filter(id=>id==='life').length>=2);
      add(redundancyOk,'Life-support redundancy present.');

      const pUsed = totalPowerUsed(); powerUsedEl.textContent=pUsed.toFixed(1);
      add(pUsed <= state.powerSupply, `Power used ≤ supply (${pUsed.toFixed(1)} / ${state.powerSupply} kW).`);

      const mUsed = totalMassUsed();  massUsedEl.textContent=mUsed.toFixed(2);
      add(mUsed <= state.massBudget, `Mass ≤ budget (${mUsed.toFixed(2)} / ${state.massBudget} t).`);

      const nearOk = state.decks.some(d=>{
        const med=d.modules.find(m=>m.libId==='med'); const air=d.modules.find(m=>m.libId==='airlock');
        return med && air ? centerDist(med,air) <= 2.0 : false;
      });
      add(nearOk,'Med Bay within 2 m of an Airlock.');

      const maxUtil = 1 - state.corridorFactor;
      const perDeckOk = state.decks.every(d=>{
        const A=deckArea(); const used=d.modules.reduce((s,m)=>s+m.w*m.h,0);
        return (used/A) <= maxUtil;
      });
      add(perDeckOk, `Per-deck utilization ≤ ${(maxUtil*100).toFixed(0)}%.`);

      const sleepCount = state.decks.flatMap(d=>d.modules).filter(m=>m.name==='Sleep Pod').length;
      const crewOk = sleepCount >= Math.ceil(state.crewSize/2);
      add(crewOk, `Sleeping capacity fits crew (pods: ${sleepCount}, crew: ${state.crewSize}).`);
    }

    function totalPowerUsed(){
      const base = sumAcrossHab('power');
      const isruP = state.isru.use ? state.isru.power_kW : 0;
      return base + isruP;
    }
    function totalMassUsed(){
      const modsT = sumAcrossHab('mass');
      const shieldT = state.shielding.applied ? state.shielding.mass_t : 0;
      const isruT = state.isru.use ? state.isru.mass_t : 0;
      return modsT + shieldT + isruT;
    }

    function updateMetrics(){
      const v=volumeM3(state.shape); volM3.textContent=v.toFixed(1);
      crewCap.textContent=Math.max(1,Math.floor(v/25));
      const d=currentDeck(); const A=deckArea(); const used=d.modules.reduce((s,m)=>s+m.w*m.h,0);
      deckAreaEl.textContent=A.toFixed(1); usedAreaEl.textContent=used.toFixed(1);
      utilPctEl.textContent=Math.round(100*used/A)+'%';
      totalAreaEl.textContent=totalArea().toFixed(1); totalVolEl.textContent=v.toFixed(1);
      // Update cost panel numbers
      const modsT = sumAcrossHab('mass'); massModules.textContent=modsT.toFixed(2);
      const importShieldT = (state.shielding.applied && !state.isru.use) ? state.shielding.mass_t : 0;
      massShieldingImported.textContent = importShieldT.toFixed(2);
      massISRU.textContent = (state.isru.use ? state.isru.mass_t : 0).toFixed(2);
      const importedT = modsT + importShieldT + (state.isru.use ? state.isru.mass_t : 0);
      massImported.textContent = importedT.toFixed(2);
      // Costs
      const kg = importedT * 1000;
      const costLeo = kg<=50 ? state.costs.first50_usd : state.costs.first50_usd + (kg-50)*state.costs.perkg_usd;
      const costDestV = costLeo * state.costs.beyondLEO;
      costLEO.textContent = fmtUSD(costLeo);
      costDest.textContent = fmtUSD(costDestV);
    }

    // -------------- Auto Designer (generate options) --------------
    function makeInst(libId){ const def=state.library.find(m=>m.id===libId); return { id:uid(), libId:def.id, name:def.name, w:def.w, h:def.h, power:def.power, mass:def.mass, color:def.color, x:0, y:0 }; }
    function shelfPack(zone, items){
      const pad=1; let cx=zone.x+pad, cy=zone.y+pad, rowH=0;
      items.forEach(m=>{
        if(cx+m.w+pad>zone.x+zone.w){ cx=zone.x+pad; cy+=rowH+pad; rowH=0; }
        if(cy+m.h+pad>zone.y+zone.h){ m.x=zone.x+zone.w-m.w-pad; m.y=zone.y+zone.h-m.h-pad; }
        else { m.x=cx; m.y=cy; cx+=m.w+pad; rowH=Math.max(rowH,m.h); }
      });
    }
    function jitter(items, amount=0.5){ items.forEach(m=>{ m.x += (Math.random()-0.5)*amount; m.y += (Math.random()-0.5)*amount; clampInHull(m); }); }

    function buildOption(preset){
      const needSleep = Math.max(1, Math.ceil(state.crewSize/2));
      const air = makeInst('airlock');
      const life = makeInst('life');
      const lifeB = makeInst('life2');
      const med = makeInst('med');
      const galley = makeInst('galley');
      const waste = makeInst('waste');
      const store = makeInst('storage');
      const exer = makeInst('exercise');
      const comms = makeInst('comms');
      const lab = makeInst('lab');
      const sleeps = Array.from({length:needSleep}, ()=>makeInst('sleep'));

      const {x,y,w,h}=state.hullBounds;
      const left  = {x:x+1, y:y+1, w:w*0.45-2, h:h-2};
      const right = {x:x+w*0.55+1, y:y+1, w:w*0.45-2, h:h-2};
      const mid   = {x:x+w*0.45+1, y:y+1, w:w*0.10-2, h:h-2};

      let groups = [];
      if (preset==='crew'){
        shelfPack(left,  [...sleeps, galley, exer]);
        shelfPack(right, [life, lifeB, lab, store, waste, comms]);
        air.x = right.x + right.w - air.w - 1; air.y = right.y + 2;
        med.x = air.x - med.w - 1; med.y = air.y;
        groups = [...sleeps, galley, exer, life, lifeB, lab, store, waste, comms, air, med];
      } else if (preset==='science'){
        shelfPack(left,  sleeps);
        shelfPack(mid,   [comms]);
        shelfPack(right, [lab, life, lifeB, store, galley, waste, exer]);
        air.x = right.x + 1; air.y = right.y + 1;
        med.x = air.x + air.w + 1; med.y = air.y;
        groups = [...sleeps, comms, lab, life, lifeB, store, galley, waste, exer, air, med];
      } else {
        shelfPack(right, [store, waste, air, life, lifeB, comms]);
        shelfPack(left,  [...sleeps, galley, exer]);
        med.x = air.x + air.w + 1; med.y = air.y;
        groups = [...sleeps, galley, exer, store, waste, air, life, lifeB, comms, med];
      }
      jitter(groups, 0.6);
      return groups;
    }

    function evaluateModules(mods){
      const A = deckArea();
      const used = mods.reduce((s,m)=>s+m.w*m.h,0);
      const utilOk = (used/A) <= (1-state.corridorFactor);

      const placedIds = new Set(mods.map(m=>m.libId));
      const requiredOk = ['airlock','life'].every(id=>placedIds.has(id));
      const redundancyOk = placedIds.has('life') && (placedIds.has('life2') || [...mods].filter(m=>m.libId==='life').length>=2);

      const med = mods.find(m=>m.libId==='med'); const air = mods.find(m=>m.libId==='airlock');
      const nearOk = med && air ? centerDist(med,air) <= 2.0 : false;

      const pUsed = mods.reduce((s,m)=>s+(m.power||0),0) + (state.isru.use?state.isru.power_kW:0);
      const mUsed = mods.reduce((s,m)=>s+(m.mass||0),0) + (state.shielding.applied?state.shielding.mass_t:0) + (state.isru.use?state.isru.mass_t:0);
      const pOk = pUsed <= state.powerSupply, mOk = mUsed <= state.massBudget;

      const sleepCount = mods.filter(m=>m.name==='Sleep Pod').length;
      const sleepOk = sleepCount >= Math.ceil(state.crewSize/2);

      const score = (requiredOk + redundancyOk + nearOk + utilOk + pOk + mOk + sleepOk) * 10 - Math.max(0,pUsed-state.powerSupply) - Math.max(0,mUsed-state.massBudget)*2;
      return { score, pUsed, mUsed, utilPct: used/A, statuses:[
        [requiredOk,'Required modules'],
        [redundancyOk,'Life-support redundancy'],
        [nearOk,'Med near Airlock'],
        [utilOk,`Utilization ≤ ${(1-state.corridorFactor)*100|0}%`],
        [pOk, 'Power ≤ supply'],
        [mOk, 'Mass ≤ budget'],
        [sleepOk, 'Sleeping capacity ok']
      ]};
    }

    function generateAutoOptions(){
      const preset = presetSelect.value;
      const n = Math.max(1, Math.min(6, parseInt(variationCount.value)||3));
      state.autoOptions = [];
      for(let i=0;i<n;i++){
        const modules = buildOption(preset);
        const evalv = evaluateModules(modules);
        state.autoOptions.push({ id: uid(), name: `${preset.charAt(0).toUpperCase()+preset.slice(1)} Option ${i+1}`, modules, evalv });
      }
      renderAutoOptions();
    }
    function renderAutoOptions(){
      autoOptionsList.innerHTML='';
      if(state.autoOptions.length===0){ autoOptionsList.innerHTML='<div class="text-xs text-slate-400">No options yet. Click <b>Generate Options</b>.</div>'; return; }
      state.autoOptions.sort((a,b)=>b.evalv.score-a.evalv.score);
      state.autoOptions.forEach(opt=>{
        const card=document.createElement('div');
        card.className='border border-slate-800 bg-slate-900/60 rounded-xl p-3';
        const rules = opt.evalv.statuses.map(([ok,msg])=> (ok?'✅ ':'⚠️ ')+msg).join(' • ');
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${opt.name}</div>
            <div class="text-xs text-slate-300">Score: <span class="font-semibold num">${opt.evalv.score.toFixed(1)}</span></div>
          </div>
          <div class="text-xs text-slate-400 mt-1">P: ${opt.evalv.pUsed.toFixed(1)} / ${state.powerSupply} kW · M: ${opt.evalv.mUsed.toFixed(2)} / ${state.massBudget} t · Util: ${(opt.evalv.utilPct*100).toFixed(0)}%</div>
          <div class="text-xs mt-1">${rules}</div>
          <div class="mt-2 flex gap-2">
            <button class="apply bg-indigo-600 hover:bg-indigo-500 rounded-lg px-2 py-1 text-xs">Apply</button>
            <button class="delete bg-slate-800 hover:bg-slate-700 rounded-lg px-2 py-1 text-xs">Remove</button>
          </div>
        `;
        card.querySelector('.apply').onclick = ()=>{
          currentDeck().modules = structuredClone(opt.modules);
          updateAll();
        };
        card.querySelector('.delete').onclick = ()=>{
          state.autoOptions = state.autoOptions.filter(o=>o.id!==opt.id);
          renderAutoOptions();
        };
        autoOptionsList.appendChild(card);
      });
    }

    // -------------- Materials UI --------------
    function renderMaterials(){
      // Cards
      matList.innerHTML='';
      MATERIALS.forEach(m=>{
        const d=document.createElement('div');
        d.className='border border-slate-800 rounded-lg p-2';
        d.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${m.name}</div>
            <div class="text-xs text-slate-400">${m.note||''}</div>
          </div>
          <div class="text-xs mt-1">Density: <span class="num">${m.density}</span> kg/m³ · Cost: <span class="num">$${m.usd_per_kg}</span>/kg</div>
        `;
        matList.appendChild(d);
      });
      // Shield select
      shieldMaterial.innerHTML='';
      SHIELD_CHOICES.forEach(id=>{
        const m = MATERIALS.find(x=>x.id===id);
        const o=document.createElement('option');
        o.value=id; o.textContent=m.name; shieldMaterial.appendChild(o);
      });
      shieldMaterial.value = state.shielding.material;
    }

    function perimeterWallsM2(){
      // Walls area for all decks: perimeter * deckHeight * decks
      const {w,h} = state.hullBounds;
      const perim = 2*(w+h);
      return perim * state.deckHeight * state.decks.length;
    }

    function updateShieldingPreview(){
      const mat = MATERIALS.find(m=>m.id===state.shielding.material);
      const areal = Math.max(0, parseFloat(shieldAreal.value)||0); // g/cm^2
      const where = shieldWhere.value;
      const area = (where==='walls') ? perimeterWallsM2() : Math.max(0, parseFloat(customArea.value)||0);
      // 1 g/cm^2 = 10 kg/m^2
      const kg_per_m2 = areal * 10;
      const total_kg = kg_per_m2 * area;
      const total_t = total_kg / 1000;
      // thickness (m) = (kg/m^2) / (kg/m^3)
      const thick_m = mat.density>0 ? (kg_per_m2 / mat.density) : 0;
      // write
      state.shielding.areal_gcm2 = areal;
      state.shielding.area_m2 = area;
      state.shielding.mass_t_calc = total_t;
      shieldArea.textContent = area.toFixed(1);
      shieldMass.textContent = total_t.toFixed(2);
      shieldThick.textContent = (thick_m*100).toFixed(1); // cm
    }

    btnApplyShield.onclick = ()=>{
      // Commit current preview as "applied" shielding mass
      state.shielding.material = shieldMaterial.value;
      const useISRU = (isruUse.value==='yes');
      const m_t = state.shielding.mass_t_calc || 0;
      state.shielding.mass_t = m_t;
      state.shielding.applied = true;
      state.isru.use = useISRU;
      updateAll();
    };
    btnClearShield.onclick = ()=>{
      state.shielding.applied = false;
      state.shielding.mass_t = 0;
      updateAll();
    };

    // -------------- Exports --------------
    function download(filename, content, mime='application/json'){
      const a=document.createElement('a'); const blob=new Blob([content], {type:mime});
      a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
    }
    function downloadJSON(){
      const snapshot = structuredClone(state);
      // don't include large autoOptions thumbnails
      snapshot.autoOptions = [];
      download('habitat_layout.json', JSON.stringify(snapshot,null,2));
    }
    function downloadPNG(){
      const s = new XMLSerializer().serializeToString(canvas);
      const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(s);
      const img = new Image();
      img.onload = ()=>{
        const c=document.createElement('canvas'); c.width=canvas.clientWidth*2; c.height=canvas.clientHeight*2;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        c.toBlob(b=>download('habitat_deck.png', b, 'image/png'));
      }; img.src=svg64;
    }

    // -------------- UI wiring --------------
    function renderShapeInputs(){
      const t=state.shape.type, d=state.shape.dims;
      const f=(id,label,val,step='0.1')=>`
        <label class="text-xs col-span-1">${label}</label>
        <input id="${id}" type="number" step="${step}" value="${val}" class="bg-slate-800 rounded-xl p-2 col-span-1" />
      `;
      let html=''; if(t==='cylinder') html=f('radius','Radius (m)',d.radius)+f('height','Height (m)',d.height);
      else if(t==='sphere') html=f('radius','Radius (m)',d.radius);
      else html=f('R','Major R (m)',d.R??10)+f('r','Tube r (m)',d.r??3);
      shapeInputs.innerHTML=html;
      ['radius','height','R','r'].forEach(id=>{
        const inp=document.getElementById(id); if(!inp) return;
        inp.addEventListener('input', ()=>{
          const v=parseFloat(inp.value)||0;
          if(t==='cylinder') state.shape.dims[id]=v;
          else if(t==='sphere' && id==='radius') state.shape.dims.radius=v;
          else state.shape.dims[id]=v;
          updateAll();
        });
      });
    }

    // Inputs
    ;[crewSizeEl, missionDaysEl, deckHeightEl, corridorFactorEl].forEach(i=>{
      i.addEventListener('input', ()=>{
        state.crewSize=parseInt(crewSizeEl.value)||0;
        state.missionDays=parseInt(missionDaysEl.value)||0;
        state.deckHeight=parseFloat(deckHeightEl.value)||2.7;
        state.corridorFactor=Math.max(0, Math.min(0.8, parseFloat(corridorFactorEl.value)||0.25));
        updateAll();
      });
    });
    powerSupplyEl.addEventListener('input', ()=>{ state.powerSupply=parseFloat(powerSupplyEl.value)||0; updateAll(); });
    massBudgetEl.addEventListener('input', ()=>{ state.massBudget=parseFloat(massBudgetEl.value)||0; updateAll(); });

    btnAddDeck.onclick=()=>{ state.decks.push({id:`D${state.decks.length+1}`,name:`Deck ${state.decks.length+1}`,modules:[]}); state.activeDeck=state.decks.length-1; updateAll(); };
    btnDelDeck.onclick=()=>{ if(state.decks.length>1){ state.decks.pop(); state.activeDeck=Math.max(0,state.activeDeck-1); updateAll(); } };
    btnAutoPlace.onclick=()=>{ autoLayoutActiveDeck(); updateAll(); };

    btnDownloadJSON.onclick=downloadJSON;
    btnDownloadPNG.onclick=downloadPNG;

    btnGenerateAuto.onclick=generateAutoOptions;
    btnClearOptions.onclick=()=>{ state.autoOptions=[]; renderAutoOptions(); };

    shapeType.addEventListener('change', ()=>{
      state.shape.type=shapeType.value;
      if(state.shape.type==='cylinder') state.shape.dims={radius:6, height:Math.max(8, state.deckHeight*state.decks.length)};
      else if(state.shape.type==='sphere') state.shape.dims={radius:8};
      else state.shape.dims={R:10, r:3};
      renderShapeInputs(); updateAll();
    });

    // Shielding UI interactions
    shieldMaterial.addEventListener('change', ()=>{ state.shielding.material = shieldMaterial.value; updateShieldingPreview(); });
    shieldAreal.addEventListener('input', updateShieldingPreview);
    shieldWhere.addEventListener('change', ()=>{
      const custom = (shieldWhere.value==='custom');
      customArea.classList.toggle('hidden', !custom);
      customAreaLbl.classList.toggle('hidden', !custom);
      updateShieldingPreview();
    });
    customArea.addEventListener('input', updateShieldingPreview);

    isruUse.addEventListener('change', ()=>{
      state.isru.use = (isruUse.value==='yes');
      updateAll();
    });
    isruMass.addEventListener('input', ()=>{ state.isru.mass_t = Math.max(0, parseFloat(isruMass.value)||0); updateAll(); });
    isruPower.addEventListener('input', ()=>{ state.isru.power_kW = Math.max(0, parseFloat(isruPower.value)||0); updateAll(); });

    cFirstBlock.addEventListener('input', ()=>{ state.costs.first50_usd = Math.max(0, parseFloat(cFirstBlock.value)||0); updateAll(); });
    cPerKg.addEventListener('input', ()=>{ state.costs.perkg_usd = Math.max(0, parseFloat(cPerKg.value)||0); updateAll(); });
    cBeyondLEO.addEventListener('input', ()=>{ state.costs.beyondLEO = Math.max(0, parseFloat(cBeyondLEO.value)||1); updateAll(); });

    // -------------- Update loop --------------
    function updateAll(){
      drawHull(); renderDeckTabs(); renderModuleLibrary(); renderModules(); updateMetrics(); checkRules(); renderAutoOptions();
      // sync UI
      shapeType.value=state.shape.type;
      powerSupplyEl.value=state.powerSupply; massBudgetEl.value=state.massBudget;
      crewSizeEl.value=state.crewSize; missionDaysEl.value=state.missionDays;
      deckHeightEl.value=state.deckHeight; corridorFactorEl.value=state.corridorFactor;
      renderShapeInputs();
      // materials panels
      renderMaterials();
      // set ISRU widgets to state
      isruUse.value = state.isru.use ? 'yes' : 'no';
      isruMass.value = state.isru.mass_t;
      isruPower.value = state.isru.power_kW;
      // cost widgets
      cFirstBlock.value = state.costs.first50_usd;
      cPerKg.value = state.costs.perkg_usd;
      cBeyondLEO.value = state.costs.beyondLEO;
      // shielding widgets + preview
      shieldMaterial.value = state.shielding.material;
      shieldAreal.value = state.shielding.areal_gcm2;
      updateShieldingPreview();
    }

    // Init
    updateAll();
  </script>
</body>
</html>
